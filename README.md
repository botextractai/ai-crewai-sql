# Natural language SQL queries with CrewAI and human-in-the-loop checkpoint

This is a [Streamlit](https://github.com/streamlit/streamlit) powered, [CrewAI](https://github.com/crewAIInc/crewAI) orchestrated multi-agent app that allows users to interact with a [SQLite](https://www.sqlite.org/) database in natural language. With a modular agent architecture for generation, review, compliance, and execution, users can safely and intuitively run SQL queries with no manual SQL writing required.

This app includes a human-in-the-loop checkpoint and displays the Large Language Model (LLM) usage costs for queries.

Costs for LLM requests are based on token usage. At the time of writing, the costs of OpenAI's "gpt-4o-mini" model are US\$ 0.15 per million input tokens, and US\$ 0.60 per million output tokens. The total costs are calculated in helper functions in the `helper.py` file.

Once a query is generated by the app, the user has 3 options:

1. `Confirm and Review`: Accept and continue if the query looks good
2. `Try Again`: Try again if the query seems off
3. `Abort`: Abort the whole process if it's not working well

![alt text](https://github.com/user-attachments/assets/8e4aeb4a-840b-4aef-a245-9e0cab90840b "Flowchart")

## How It Works

This app uses a CrewAI based multi-agent system to process each user query through a collaborative pipeline:

1. **Natural Language Input (User)**
   User asks question in everyday natural language using the Streamlit web front end.

2. **SQL Generation Agent**
   Converts the user prompt into a SQL query using schema context and user intent.

3. **Query Review Agent**
   Refines and optimises the SQL query for correctness and performance.

4. **Compliance Agent**
   Validates the SQL for data safety (e.g., prevents `DROP`, `DELETE`, `ALTER`, etc.)

5. **Execution Agent**
   Runs the approved SQL query against the SQLite database and returns results to the user.

6. **Schema Sync Agent**
   Allows on-demand schema refresh, so that agents stay aware of the current database structure.

## Required API key for this example

You need an OpenAI API key for this example. [Get your OpenAI API key here](https://platform.openai.com/login). Insert the OpenAI API key into the `.env.example` file and then rename this file to just `.env` (remove the ".example" ending).

## Run this example

Run the app from command line with:

```
streamlit run app.py
```

You can then view the Streamlit web interface in your browser with the URL shown in terminal, for example:

```
http://localhost:8501
```
